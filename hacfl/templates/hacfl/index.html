<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æœ¬éƒ¨ç™ºæ³¨ ç™»éŒ²ç”»é¢</title>
    <style>
        body {
            font-family: "Meiryo", sans-serif;
            background-color: #f4f6f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px; /* â˜…å°‘ã—åºƒã’ã¾ã—ãŸ */
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ */
        .mode-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
        }

        .mode-label {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 30px;
            border-radius: 30px;
            cursor: pointer;
            border: 2px solid transparent;
            opacity: 0.6;
            transition: 0.3s;
            background: #fff; /* æœªé¸æŠæ™‚ã‚‚ç™½èƒŒæ™¯ã§è¦‹ã‚„ã™ã */
            color: #555;
        }

        input[type="radio"] {
            display: none;
        }

        /* é¸æŠæ™‚ã®è‰²å¤‰åŒ– */
        #rb_normal:checked + .mode-label {
            background: #007bff;
            color: #fff;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(0,123,255,0.4);
        }

        #rb_morning:checked + .mode-label {
            background: #dc3545;
            color: #fff;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(220,53,69,0.4);
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-box {
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            position: relative;
            transition: opacity 0.3s; /* ç„¡åŠ¹æ™‚ã®å¤‰åŒ–ã‚’ãªã‚ã‚‰ã‹ã« */
        }

        /* ç„¡åŠ¹çŠ¶æ…‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-disabled {
            opacity: 0.5;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯è‡ªä½“ã‚’ç¦æ­¢ */
            background-color: #f9f9f9;
        }

        .section-title {
            position: absolute;
            top: -12px;
            left: 20px;
            background: #fff;
            padding: 0 10px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ */
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* ç„¡åŠ¹åŒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        input:disabled {
            background-color: #e9ecef !important;
            cursor: not-allowed;
            color: #6c757d;
            border-color: #ddd;
        }

        button {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-display {
            font-size: 0.85em;
            color: #0056b3;
            margin-top: 4px;
            min-height: 1.2em;
        }

        .info-error {
            color: #dc3545;
        }
    </style>

    <script>
        // ==========================================
        //  æ—¥ä»˜è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ==========================================
        function formatDate(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getTodayDate() {
            return formatDate(new Date());
        }

        function getNextDay(dateStr) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + 1);
            return formatDate(d);
        }

        function getLimitDate() {
            const d = new Date();
            d.setDate(d.getDate() + 40);
            return formatDate(d);
        }

        // ==========================================
        //  1. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã®å…¨ä½“åˆ¶å¾¡ (â˜…å¤§å¹…ä¿®æ­£)
        // ==========================================
        async function updateMode() {
            const rbNormal = document.getElementById('rb_normal');
            const rbMorning = document.getElementById('rb_morning');

            const isNormal = rbNormal.checked;
            const isMorning = rbMorning.checked;
            const isNone = !isNormal && !isMorning;

            // ãƒ¢ãƒ¼ãƒ‰å€¤ã‚’ã‚»ãƒƒãƒˆ
            const mode = isMorning ? "morning" : (isNormal ? "normal" : "");
            document.getElementById('hidden_mode_single').value = mode;
            document.getElementById('hidden_mode_csv').value = mode;

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
            const singleSection = document.getElementById('section_single');
            const csvSection = document.getElementById('section_csv');

            // --- å…±é€š: æœªé¸æŠãªã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨è–„ãã—ã¦è§¦ã‚Œãªãã™ã‚‹ ---
            if (isNone) {
                singleSection.classList.add('section-disabled');
                csvSection.classList.add('section-disabled');

                // å…¨ã¦ã®å…¥åŠ›ã‚’ç„¡åŠ¹åŒ– (å¿µã®ãŸã‚å€‹åˆ¥ã«å›ã™)
                disableAllInputsIn(singleSection, true);
                disableAllInputsIn(csvSection, true);
            } else {
                // ãƒ¢ãƒ¼ãƒ‰é¸æŠä¸­: ã‚»ã‚¯ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–
                singleSection.classList.remove('section-disabled');
                csvSection.classList.remove('section-disabled');

                // åŸºæœ¬çš„ã«ä¸€æ—¦å…¨éƒ¨æœ‰åŠ¹ã«ã™ã‚‹
                disableAllInputsIn(singleSection, false);
                disableAllInputsIn(csvSection, false);

                // === ã“ã“ã‹ã‚‰ãƒ¢ãƒ¼ãƒ‰åˆ¥å¾®èª¿æ•´ ===

                // 1. å˜ç™ºç™»éŒ²ã®ç™ºæ³¨æ—¥
                const singleOddt = document.getElementById('single_oddt');
                if (isMorning) {
                    singleOddt.value = "";
                    singleOddt.disabled = true; // æœç· ã‚ã¯æŒ‡å®šä¸å¯
                    singleOddt.placeholder = "å½“æ—¥æ‰±ã„";
                } else {
                    singleOddt.disabled = false;
                    singleOddt.placeholder = "";
                }

                // 2. CSVç™»éŒ²ã®ç™ºæ³¨æ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                const chkOddt = document.getElementById('chk_oddt');
                const chkDldt = document.getElementById('chk_dldt');

                if (isMorning) {
                    chkOddt.checked = false;
                    chkOddt.disabled = true; // æœç· ã‚ã¯ãƒã‚§ãƒƒã‚¯ä¸å¯
                    toggleDateInput(chkOddt, 'csv_oddt'); // å…¥åŠ›æ¬„ã‚‚é€£å‹•ã—ã¦OFF
                } else {
                    chkOddt.disabled = false;
                    // å…¥åŠ›æ¬„ã®çŠ¶æ…‹æ›´æ–° (ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«å¾“ã†)
                    toggleDateInput(chkOddt, 'csv_oddt');
                }

                // CSVç´å“æ—¥ãƒã‚§ãƒƒã‚¯ã¯å¸¸ã«æœ‰åŠ¹ã€ãŸã ã—å…¥åŠ›æ¬„ã¯ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«å¾“ã†
                toggleDateInput(chkDldt, 'csv_dldt');
            }

            // --- ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–° ---
            updateButtons(mode, isNone);

            // APIæ™‚é–“ãƒã‚§ãƒƒã‚¯
            if (!isNone) {
                checkTimeAPI(mode);
            }
        }

        // æŒ‡å®šã‚¨ãƒªã‚¢å†…ã® input/select/textarea ã‚’ä¸€æ‹¬åˆ¶å¾¡
        function disableAllInputsIn(container, disabled) {
            const inputs = container.querySelectorAll('input, select, textarea');
            inputs.forEach(el => {
                // hiddenã¯è§¦ã‚‰ãªã„
                if (el.type === 'hidden') return;
                // dateã‚¿ã‚¤ãƒ—ã¯ toggleDateInput ã§ç®¡ç†ã—ãŸã„ã®ã§ã€
                // ã“ã“ã§ã¯ã€Œæœ‰åŠ¹åŒ–(disabled=false)ã€ã®ã¨ãã ã‘ä¸€æ—¦è¨±å¯ã—ã€
                // ãã®å¾Œå€‹åˆ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã§å†ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹æµã‚Œã«ã™ã‚‹
                el.disabled = disabled;
            });
        }

        function updateButtons(mode, isNone) {
            const btns = document.querySelectorAll('.btn-submit');
            btns.forEach(btn => {
                let baseText = btn.getAttribute('data-base-text') || btn.innerText.split('ï¼ˆ')[0];
                if (!btn.getAttribute('data-base-text')) {
                    btn.setAttribute('data-base-text', baseText);
                }

                if (isNone) {
                    btn.style.backgroundColor = "#ccc";
                    btn.disabled = true;
                    btn.style.cursor = "not-allowed";
                    btn.innerText = "æ¥­å‹™ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„";
                } else {
                    btn.disabled = false;
                    btn.style.cursor = "pointer";
                    if (mode === "normal") {
                        btn.style.backgroundColor = "#007bff";
                        btn.innerText = baseText + "ï¼ˆé€šå¸¸äºˆç´„ï¼‰";
                    } else {
                        btn.style.backgroundColor = "#dc3545";
                        btn.innerText = baseText + "ï¼ˆå½“æ—¥æœç· ã‚ï¼‰";
                    }
                }
            });
        }

        async function checkTimeAPI(mode) {
            if(!mode) return;
            const errDiv = document.getElementById('js_time_error');
            if(errDiv) errDiv.style.display = 'none';

            try {
                const res = await fetch(`{{ url_for('hacfl.api_check_mode_time') }}?mode=${mode}&t=${new Date().getTime()}`);
                const data = await res.json();
                if (!data.valid) {
                    if(errDiv) {
                        errDiv.innerText = data.message;
                        errDiv.style.display = 'block';
                    }
                    // æ™‚é–“å¤–ãªã‚‰ãƒœã‚¿ãƒ³ã ã‘ç„¡åŠ¹åŒ–
                    document.querySelectorAll('.btn-submit').forEach(btn => {
                        btn.disabled = true;
                        btn.style.backgroundColor = "#ccc";
                        btn.style.cursor = "not-allowed";
                        btn.innerText += " (å—ä»˜æ™‚é–“å¤–)";
                    });
                }
            } catch(e) { console.error(e); }
        }

        // ==========================================
        //  2. æ—¥ä»˜å…¥åŠ›ã®åˆ¶é™
        // ==========================================
        function setDateConstraints() {
            const today = getTodayDate();
            const limit = getLimitDate(); // 40æ—¥å¾Œ

            const pairs = [
                ['single_oddt', 'single_dldt'],
                ['csv_oddt', 'csv_dldt']
            ];

            pairs.forEach(pair => {
                const oddtInput = document.getElementById(pair[0]);
                const dldtInput = document.getElementById(pair[1]);

                if(!oddtInput || !dldtInput) return;

                oddtInput.min = today;
                oddtInput.max = limit;
                dldtInput.min = getNextDay(today);
                dldtInput.max = limit;

                oddtInput.addEventListener('change', function() {
                    const orderDate = this.value;
                    if (orderDate) {
                        const minDelivery = getNextDay(orderDate);
                        dldtInput.min = minDelivery;
                        if (dldtInput.value && dldtInput.value < minDelivery) {
                            dldtInput.value = "";
                        }
                    } else {
                        dldtInput.min = getNextDay(today);
                    }
                });
            });
        }

        // ==========================================
        //  3. CSVã‚¨ãƒªã‚¢ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡
        // ==========================================
        function toggleDateInput(checkbox, targetId) {
            const input = document.getElementById(targetId);
            // è¦ªãŒç„¡åŠ¹ãªã‚‰å¼·åˆ¶OFF
            if (checkbox.disabled) {
                input.disabled = true;
                input.value = "";
                input.style.backgroundColor = "#e9ecef";
                return;
            }

            if (checkbox.checked) {
                input.disabled = false;
                input.style.backgroundColor = "#fff";
            } else {
                input.disabled = true;
                input.value = "";
                input.style.backgroundColor = "#e9ecef";
            }
        }

        // ==========================================
        //  4. AJAX (åº—èˆ—/å•†å“)
        // ==========================================
        async function fetchStoreName(input) {
            const cucd = input.value.trim();
            const disp = document.getElementById('disp_store_name');
            if (cucd.length !== 3) { disp.innerText = ""; return; }
            try {
                const res = await fetch(`{{ url_for('hacfl.api_get_store_name') }}?cucd=${cucd}`);
                const data = await res.json();
                if (data.found) {
                    disp.innerText = data.name;
                    disp.className = "info-display";
                } else {
                    disp.innerText = "ãƒã‚¹ã‚¿æœªç™»éŒ²";
                    disp.className = "info-display info-error";
                }
            } catch (e) { disp.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
        }

        async function fetchProductInfo(input) {
            const cocd = input.value.trim();
            const dispName = document.getElementById('disp_prod_name');
            const dispDetail = document.getElementById('disp_prod_detail');
            if (cocd.length !== 8) {
                dispName.innerText = ""; dispDetail.innerText = ""; return;
            }
            try {
                const res = await fetch(`{{ url_for('hacfl.api_get_product_info') }}?cocd=${cocd}`);
                const data = await res.json();
                if (data.found) {
                    const i = data.info;
                    dispName.innerText = i.name;
                    dispDetail.innerText = `è¦æ ¼:${i.kika} / ${i.maker} / å…¥æ•°:${i.irsu}`;
                    dispName.className = "info-display";
                    dispDetail.className = "info-display";
                } else {
                    dispName.innerText = "ãƒã‚¹ã‚¿æœªç™»éŒ²";
                    dispName.className = "info-display info-error";
                    dispDetail.innerText = "";
                }
            } catch (e) { dispName.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
        }

        // ==========================================
        //  5. é€ä¿¡æ™‚ãƒã‚§ãƒƒã‚¯
        // ==========================================
        function validateForm(event) {
            const form = event.target;
            const isCsv = form.querySelector('input[name="action_type"]').value === 'csv';

            if (isCsv) {
                const oddtChk = document.getElementById('chk_oddt');
                const dldtChk = document.getElementById('chk_dldt');
                const oddtVal = document.getElementById('csv_oddt').value;
                const dldtVal = document.getElementById('csv_dldt').value;

                if (oddtChk.checked && !oddtVal) {
                    alert("ç™ºæ³¨æ—¥ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    event.preventDefault(); return false;
                }
                if (dldtChk.checked && !dldtVal) {
                    alert("ç´å“æ—¥ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    event.preventDefault(); return false;
                }
                if (oddtVal && dldtVal && oddtVal >= dldtVal) {
                    alert("ç´å“æ—¥ã¯ç™ºæ³¨æ—¥ã®ç¿Œæ—¥ä»¥é™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                    event.preventDefault(); return false;
                }
            } else {
                const oddtVal = document.getElementById('single_oddt').value;
                const dldtVal = document.getElementById('single_dldt').value;

                if (oddtVal && dldtVal && oddtVal >= dldtVal) {
                    alert("ç´å“æ—¥ã¯ç™ºæ³¨æ—¥ã®ç¿Œæ—¥ä»¥é™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                    event.preventDefault(); return false;
                }
            }

            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "é€ä¿¡ä¸­...";
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            setDateConstraints();
            updateMode(); // ã“ã‚ŒãŒåˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«èµ°ã‚Šã€å…¨å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™
        });
    </script>
</head>
<body>

    <div class="container">
        <h2>æœ¬éƒ¨ç™ºæ³¨ ç™»éŒ²ç”»é¢</h2>

        <div id="js_time_error" class="alert-error" style="display:none; text-align:center;"></div>
        {% if error %} <div class="alert-error">{{ error }}</div> {% endif %}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert-success">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="mode-area">
            <input type="radio" name="mode_select" id="rb_normal" onchange="updateMode()"
                   {% if mode=='normal' %}checked{% endif %}>
            <label for="rb_normal" class="mode-label">é€šå¸¸äºˆç´„</label>

            <input type="radio" name="mode_select" id="rb_morning" onchange="updateMode()"
                   {% if mode=='morning' %}checked{% endif %}>
            <label for="rb_morning" class="mode-label">å½“æ—¥æœç· ã‚</label>
        </div>

        <div class="section-box" id="section_single">
            <span class="section-title">å˜ç™ºãƒ‡ãƒ¼ã‚¿ç™»éŒ²</span>
            <form method="post" onsubmit="validateForm(event)">
                <input type="hidden" name="action_type" value="single">
                <input type="hidden" name="mode" id="hidden_mode_single">

                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 30%;">
                        <label>åº—èˆ—CD</label>
                        <input type="text" name="cucd" maxlength="3" required placeholder="111" onblur="fetchStoreName(this)" disabled>
                        <div id="disp_store_name" class="info-display"></div>
                    </div>

                    <div class="form-group">
                        <label>å•†å“CD</label>
                        <input type="text" name="cocd" maxlength="8" required placeholder="12345678" onblur="fetchProductInfo(this)" disabled>
                        <div id="disp_prod_name" class="info-display" style="font-weight:bold;"></div>
                        <div id="disp_prod_detail" class="info-display" style="color:#666;"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç™ºæ³¨æ•°</label>
                        <input type="number" name="odsu" required min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label>ç™ºæ³¨æ—¥(ä»»æ„)</label>
                        <input type="date" name="oddt" id="single_oddt" disabled>
                    </div>
                    <div class="form-group">
                        <label>ç´å“æ—¥(ä»»æ„)</label>
                        <input type="date" name="dldt" id="single_dldt" disabled>
                    </div>
                </div>
                <button type="submit" class="btn-submit" disabled>ç™»éŒ²ã™ã‚‹</button>
            </form>
        </div>

        <div class="section-box" id="section_csv" style="margin-bottom:0;">
            <span class="section-title">CSVä¸€æ‹¬ç™»éŒ²</span>
            <form method="post" enctype="multipart/form-data" onsubmit="validateForm(event)">
                <input type="hidden" name="action_type" value="csv">
                <input type="hidden" name="mode" id="hidden_mode_csv">

                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="chk_oddt" id="chk_oddt" onchange="toggleDateInput(this, 'csv_oddt')" disabled>
                            ç™ºæ³¨æ—¥ã‚’æŒ‡å®šã™ã‚‹
                        </label>
                        <input type="date" name="csv_oddt" id="csv_oddt" disabled>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="chk_dldt" id="chk_dldt" onchange="toggleDateInput(this, 'csv_dldt')" disabled>
                            ç´å“æ—¥ã‚’æŒ‡å®šã™ã‚‹
                        </label>
                        <input type="date" name="csv_dldt" id="csv_dldt" disabled>
                    </div>
                </div>

                <div style="padding: 20px; background:#f8f9fa; border:2px dashed #ccc; text-align:center; margin-bottom:15px;">
                    <input type="file" name="csv_file" accept=".csv" required disabled>
                    <p style="font-size:0.8em; color:#666; margin-top:5px;">
                        â€»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: åº—èˆ—CD, å•†å“CD, ç™ºæ³¨æ•° (3åˆ—)
                    </p>
                </div>

                <button type="submit" class="btn-submit" disabled>ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€</button>

                <div style="text-align:right; margin-top:10px;">
                    <a href="{{ url_for('hacfl.download_template') }}" style="font-size:0.9em; color:#007bff;">
                        ğŸ“¥ é››å½¢CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            </form>
        </div>

    </div>

</body>
</html>