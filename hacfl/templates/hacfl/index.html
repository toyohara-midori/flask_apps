<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æœ¬éƒ¨ç™ºæ³¨ ç™»éŒ²ç”»é¢</title>
    <style>
        body {
            font-family: "Meiryo", sans-serif;
            background-color: #f4f6f9;
            padding: 20px;
            color: #333;
        }

        .container {
            max_width: 700px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ */
        .mode-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
        }

        .mode-label {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 30px;
            border-radius: 30px;
            cursor: pointer;
            border: 2px solid transparent;
            opacity: 0.6;
        }

        input[type="radio"] {
            display: none;
        }

        /* é¸æŠæ™‚ã®è‰²å¤‰åŒ– */
        #rb_normal:checked + .mode-label {
            background: #007bff;
            color: #fff;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(0,123,255,0.4);
        }

        #rb_morning:checked + .mode-label {
            background: #dc3545;
            color: #fff;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(220,53,69,0.4);
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-box {
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            position: relative;
        }

        .section-title {
            position: absolute;
            top: -12px;
            left: 20px;
            background: #fff;
            padding: 0 10px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ */
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-submit {
            background-color: #555;
        }
        /* JSã§è‰²ãŒå¤‰ã‚ã‚‹ */

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* â˜…è¿½åŠ : æƒ…å ±è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« (åº—åãªã©ã‚’è¡¨ç¤ºã™ã‚‹æ–‡å­—) */
        .info-display {
            font-size: 0.85em;
            color: #0056b3;
            margin-top: 4px;
            min-height: 1.2em;
        }

        .info-error {
            color: #dc3545;
        }
    </style>

    <script>
        // --- 1. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã®è¡¨ç¤ºåˆ¶å¾¡ ---
        async function updateMode() {
            const rbNormal = document.getElementById('rb_normal');
            const rbMorning = document.getElementById('rb_morning');
            const btns = document.querySelectorAll('.btn-submit');

            // â˜…è¿½åŠ : ã©ã£ã¡ã‚‚é¸ã°ã‚Œã¦ã„ãªã„å ´åˆ (åˆæœŸçŠ¶æ…‹)
            if (!rbNormal.checked && !rbMorning.checked) {
                btns.forEach(btn => {
                    btn.disabled = true;
                    btn.style.backgroundColor = "#ccc";
                    btn.style.cursor = "not-allowed";
                    btn.style.opacity = "0.6";
                    // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã—ã¤ã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ã®ã¯é›£ã—ã„ã®ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã«
                    if (btn.innerText.includes("ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€")) {
                         btn.innerText = "æ¥­å‹™ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„";
                    } else {
                         btn.innerText = "æ¥­å‹™ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„";
                    }
                });
                return; // ã“ã“ã§çµ‚äº†
            }

            // --- ä»¥ä¸‹ã€é¸æŠã•ã‚ŒãŸå¾Œã®å‡¦ç† ---

            let mode = "";
            if(rbNormal.checked) mode = "normal";
            else mode = "morning";

            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆ
            document.getElementById('hidden_mode_single').value = mode;
            document.getElementById('hidden_mode_csv').value = mode;

            // å•ã„åˆã‚ã›ä¸­è¡¨ç¤º
            btns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.style.cursor = "wait";
                btn.innerText = "ç¢ºèªä¸­...";
            });

            // ---------------------------------------------------------
            // APIå•ã„åˆã‚ã›: DBæ™‚é–“ãƒã‚§ãƒƒã‚¯
            // ---------------------------------------------------------
            let isError = false;
            let errorMsg = "";

            try {
                const res = await fetch(`{{ url_for('hacfl.api_check_mode_time') }}?mode=${mode}&t=${new Date().getTime()}`);
                const data = await res.json();

                if (!data.valid) {
                    isError = true;
                    errorMsg = data.message;
                }
            } catch (e) {
                console.error(e);
                isError = true;
                errorMsg = "ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚¨ãƒ©ãƒ¼";
            }

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢åˆ¶å¾¡
            let errDiv = document.getElementById('js_time_error');
            if (!errDiv) {
                const modeArea = document.querySelector('.mode-area');
                errDiv = document.createElement('div');
                errDiv.id = 'js_time_error';
                errDiv.className = 'alert-error';
                errDiv.style.textAlign = 'center';
                errDiv.style.fontWeight = 'bold';
                errDiv.style.marginBottom = '20px';
                modeArea.parentNode.insertBefore(errDiv, modeArea.nextSibling);
            }

            if (isError) {
                errDiv.innerText = errorMsg;
                errDiv.style.display = 'block';
            } else {
                errDiv.style.display = 'none';
            }

            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            btns.forEach(btn => {
                // ãƒœã‚¿ãƒ³ã®å…ƒã®æ–‡è¨€ã‚’å¾©å…ƒã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                // (CSVå´ã‹å˜ç™ºå´ã‹ã§æ–‡è¨€ãŒé•ã†ãŸã‚ã€è¦ªè¦ç´ ãªã©ã§åˆ¤å®šã™ã‚‹ã‹ã€å›ºå®šæ–‡å­—ã«ã™ã‚‹)
                // ä»Šå›ã¯ç°¡æ˜“çš„ã«ã€HTMLã®æ§‹é€ ï¼ˆnameå±æ€§ãªã©ï¼‰ã‚’è¦‹ãšã«ã€
                // ã“ã®é–¢æ•°ã®å¤–å´ï¼ˆHTMLï¼‰ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€ŒåˆæœŸæ–‡è¨€ã€ã«æˆ»ã™ã®ã¯é›£ã—ã„ãŸã‚ã€
                // ã‚·ãƒ³ãƒ—ãƒ«ã«æ¡ä»¶åˆ†å²ã§æ›¸ãæˆ»ã—ã¾ã™ã€‚

                let baseText = "ç™»éŒ²ã™ã‚‹"; // å˜ç™ºå´ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                // ã‚‚ã—è¦ªãƒ•ã‚©ãƒ¼ãƒ ãŒCSVç”¨ãªã‚‰
                if (btn.closest('form').querySelector('input[name="csv_file"]')) {
                    baseText = "ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€";
                }

                if (isError) {
                    btn.disabled = true;
                    btn.style.backgroundColor = "#ccc";
                    btn.style.cursor = "not-allowed";
                    btn.style.opacity = "1.0";
                    btn.innerText = baseText + "ï¼ˆå—ä»˜æ™‚é–“å¤–ï¼‰";
                } else {
                    btn.disabled = false;
                    btn.style.cursor = "pointer";
                    btn.style.opacity = "1.0";

                    if(mode === "normal") {
                        btn.style.backgroundColor = "#007bff";
                        btn.innerText = baseText + "ï¼ˆé€šå¸¸äºˆç´„ï¼‰";
                    } else {
                        btn.style.backgroundColor = "#dc3545";
                        btn.innerText = baseText + "ï¼ˆå½“æ—¥æœç· ã‚ï¼‰";
                    }
                }
            });
        }
        // --- 2. åº—èˆ—åå–å¾— (AJAX) ---
        async function fetchStoreName(input) {
            const cucd = input.value.trim();
            const disp = document.getElementById('disp_store_name');

            // 3æ¡æœªæº€ãªã‚‰ã‚¯ãƒªã‚¢ã—ã¦çµ‚äº†
            if (cucd.length !== 3) {
                disp.innerText = "";
                return;
            }

            try {
                // ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›
                const res = await fetch(`{{ url_for('hacfl.api_get_store_name') }}?cucd=${cucd}`);
                const data = await res.json();

                if (data.found) {
                    disp.innerText = data.name;
                    disp.className = "info-display";
                } else {
                    disp.innerText = "ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“";
                    disp.className = "info-display info-error";
                }
            } catch (e) {
                console.error(e);
                disp.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
            }
        }

        // --- 3. å•†å“æƒ…å ±å–å¾— (AJAX) ---
        async function fetchProductInfo(input) {
            const cocd = input.value.trim();
            const dispName = document.getElementById('disp_prod_name');
            const dispDetail = document.getElementById('disp_prod_detail');

            // 8æ¡æœªæº€ãªã‚‰ã‚¯ãƒªã‚¢ã—ã¦çµ‚äº†
            if (cocd.length !== 8) {
                dispName.innerText = "";
                dispDetail.innerText = "";
                return;
            }

            try {
                const res = await fetch(`{{ url_for('hacfl.api_get_product_info') }}?cocd=${cocd}`);
                const data = await res.json();

                if (data.found) {
                    const i = data.info;
                    dispName.innerText = i.name;
                    dispDetail.innerText = `è¦æ ¼:${i.kika} / ${i.maker} / å…¥æ•°:${i.irsu} / Bå˜:${i.btan}`;

                    dispName.className = "info-display";
                    dispDetail.className = "info-display";
                } else {
                    dispName.innerText = "ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“";
                    dispName.className = "info-display info-error";
                    dispDetail.innerText = "";
                }
            } catch (e) {
                console.error(e);
                dispName.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ (ã“ã‚Œã§åˆæœŸçŠ¶æ…‹ï¼å…¨ç„¡åŠ¹ã«ãªã‚‹)
        window.onload = updateMode;

        // ç¢ºèªç”»é¢ã®ã¨ãã¨åŒã˜ã‚ˆã†ãªé–¢æ•°ã‚’è¿½åŠ 
        function disableSubmit(btn) {
            // ãƒ•ã‚©ãƒ¼ãƒ ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ (requiredå±æ€§ãªã©ãŒOKã‹)
            if (btn.form.checkValidity()) {
                btn.disabled = true;
                btn.innerText = "ç™»éŒ²ä¸­...";
                btn.form.submit(); // JSã§é€ä¿¡
            }
        }
    </script>
</head>
<body>

    <div class="container">
        <h2>æœ¬éƒ¨ç™ºæ³¨ ç™»éŒ²ç”»é¢</h2>

        {% if error %} <div class="alert-error">{{ error }}</div> {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert-success">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="mode-area">
            <input type="radio" name="mode_select" id="rb_normal" onchange="updateMode()"
                   {% if mode=='normal' %}checked{% endif %}>
            <label for="rb_normal" class="mode-label">é€šå¸¸äºˆç´„</label>

            <input type="radio" name="mode_select" id="rb_morning" onchange="updateMode()"
                   {% if mode=='morning' %}checked{% endif %}>
            <label for="rb_morning" class="mode-label">å½“æ—¥æœç· ã‚</label>
        </div>

        <div class="section-box">
            <span class="section-title">å˜ç™ºãƒ‡ãƒ¼ã‚¿ç™»éŒ²</span>
            <form method="post">
                <input type="hidden" name="action_type" value="single">
                <input type="hidden" name="mode" id="hidden_mode_single">

                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 30%;">
                        <label>åº—èˆ—CD</label>
                        <input type="text" name="cucd" maxlength="3" required placeholder="111" onblur="fetchStoreName(this)" autofocus>
                        <div id="disp_store_name" class="info-display"></div>
                    </div>

                    <div class="form-group">
                        <label>å•†å“CD</label>
                        <input type="text" name="cocd" maxlength="8" required placeholder="12345678" onblur="fetchProductInfo(this)">
                        <div id="disp_prod_name" class="info-display" style="font-weight:bold;"></div>
                        <div id="disp_prod_detail" class="info-display" style="color:#666;"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç™ºæ³¨æ•°</label>
                        <input type="number" name="odsu" required>
                    </div>
                    <div class="form-group">
                        <label>ç™ºæ³¨æ—¥(ä»»æ„)</label>
                        <input type="date" name="oddt">
                    </div>
                    <div class="form-group">
                        <label>ç´å“æ—¥(ä»»æ„)</label>
                        <input type="date" name="dldt">
                    </div>
                </div>
                <button type="submit" class="btn-submit" onclick="disableSubmit(this)">ç™»éŒ²ã™ã‚‹</button>
            </form>
        </div>

        <div class="section-box" style="margin-bottom:0;">
            <span class="section-title">CSVä¸€æ‹¬ç™»éŒ²</span>
            <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="action_type" value="csv">
                <input type="hidden" name="mode" id="hidden_mode_csv">

                <div style="padding: 20px; background:#f8f9fa; border:2px dashed #ccc; text-align:center; margin-bottom:15px;">
                    <input type="file" name="csv_file" accept=".csv" required>
                </div>

                <button type="submit" class="btn-submit">ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€</button>

                <div style="text-align:right; margin-top:10px;">
                    <a href="{{ url_for('hacfl.download_template') }}" style="font-size:0.9em; color:#007bff;">
                        ğŸ“¥ é››å½¢CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            </form>
        </div>

    </div>

</body>
</html>