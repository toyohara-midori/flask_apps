# 内部設計書：本部発注登録機能 (hacfl)

## 1. 概要
本機能は、本部担当者が店舗および商品の発注データを登録するためのWebアプリケーションである。
「通常予約（夜締め）」と「当日朝締め」の2つの業務モードを持ち、画面からの単発登録およびCSVによる一括登録を提供する。

---

## 2. システム構成・配置

### 2.1 ディレクトリ構成
本機能は `flask_apps` リポジトリ内の `hacfl` モジュールとして実装される。

- **hacfl/**
    - `__init__.py`: Blueprint定義、アクセス制御、認証フック
    - `views.py`: 画面ルーティング、コントローラー処理
    - `templates/hacfl/`: HTMLテンプレート (`index.html`, `confirm.html`, `complete.html`)
    - `docs/`: ドキュメント格納
- **common/** (共通部品)
    - `hacfl_db_logic.py`: **本機能の主要DBロジック**（設定、バリデーション、登録）
    - `ad_tool.py`: AD認証・権限チェック
    - `db_connection.py`: DB接続管理

### 2.2 依存関係
- **データベース**: Sybase SQL Anywhere (想定)
- **認証基盤**: IIS統合認証 (REMOTE_USER) + Active Directory (net userコマンドによるグループ判定)

---

## 3. 設定・セキュリティ設計（重要）

本システムにおける「稼働時間」および「利用可能ユーザー」の制御は、以下のソースコード内の定数定義により管理する。

### 3.1 稼働時間・モード設定
業務モードごとの受付時間、および登録先テーブルの切り替え設定。

* **設定ファイル**: `common/hacfl_db_logic.py`
* **設定変数**: `MODE_CONFIG`

**▼ 現状の設定値**

| モードID | 名称 | 登録先テーブル | 受付開始 | 受付終了 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `normal` | 通常予約 | `DBA.hacflr` | 08:00 | 20:00 | 発注日指定：**可** |
| `morning` | 当日朝締め | `DBA.hacfl04` | 05:00 | 10:50 | 発注日指定：**不可** (強制NULL) |

**▼ 設定変更手順**
時間を変更する場合、`hacfl_db_logic.py` 内の以下の箇所を修正し、アプリケーションを再起動（またはリロード）する。

```python
MODE_CONFIG = {
    'normal': {
        'name': '通常予約',
        'table': 'DBA.hacflr',
        'start': '08:00',  # ← 開始時間を変更
        'end':   '20:00'   # ← 終了時間を変更
    },
    # ... (省略)
}
```

### 3.2 ユーザー権限・アクセス制限
本機能を利用できるユーザーは、Active Directoryのセキュリティグループによって制限される。

* **設定ファイル**: `hacfl/__init__.py`
* **設定変数**: `allowed_groups`

**▼ 許可されているグループ（現状）**
以下のいずれかのグループに所属しているユーザーのみアクセスが可能。
1. `Domain Admins`
2. `G-商品部ディストリビューター`
3. `G-商品部バイヤー`
4. `G-システム管理部`

**▼ 設定変更手順**
利用可能部署を追加・削除する場合、`hacfl/__init__.py` のリストを修正する。

```python
    # 4. ADグループ権限チェック
    allowed_groups = [
        'Domain Admins',
        'G-商品部ディストリビューター',
        'G-商品部バイヤー',
        'G-システム管理部',
        'G-新規追加部署'  # ← 必要に応じて追加
    ]
```

---

## 4. データベース設計

### 4.1 ターゲットテーブル (本登録先)
モードにより挿入先が切り替わる。

1.  **DBA.hacflr** (通常予約用)
    * 利用モード: `normal`
    * 特徴: 夜間バッチ等で処理される予約データ。
2.  **DBA.hacfl04** (当日朝締め用)
    * 利用モード: `morning`
    * 特徴: 当日の朝に即時処理が必要なデータ。

### 4.2 ワークテーブル (CSV一時登録用)
CSVアップロード時のバリデーションおよび一時保存に使用する。

* **テーブル名**: `DBA.hacfl04_work`
* **主なカラム**:
    * `batch_id`: UUID (ユーザー・セッションごとの識別子)
    * `line_num`: CSV行番号
    * `cucd`: 店舗CD
    * `cocd`: 商品CD
    * `odsu`: 発注数
    * `oddt`: 発注日 (Morningモード時はNULL)
    * `dldt`: 納品日
    * `err_msg`: エラー内容（バリデーション結果）
    * `updt`: 更新日（ガベージコレクション用）

---

## 5. 機能ロジック詳細

### 5.1 共通バリデーション (DBロジック)
`exec_db_validation` 関数にてSQLによる一括チェックを行う。

1.  **マスタ存在チェック**:
    * 店舗マスタ (`DBA.cusmf04`) に `cucd` が存在すること。
    * 商品マスタ (`DBA.comf1`) に `cocd` が存在すること。
2.  **値形式チェック**:
    * 店舗CDにスペースが含まれていないか。
    * 発注数が0でないか。
3.  **日付整合性チェック**:
    * **過去日チェック**: 発注日(`oddt`)、納品日(`dldt`)が当日より前でないこと。
    * **未来日制限**: 当日から40日以内の日付であること。
    * **矛盾チェック**: 納品日は発注日の翌日以降であること (`oddt < dldt`)。

### 5.2 モード別挙動差異

| 項目 | Normal (通常) | Morning (朝締め) |
| :--- | :--- | :--- |
| **発注日 (oddt)** | 任意指定可 (未指定時はNULL) | **強制NULL** (プログラム側でNULL置換) |
| **画面制御** | 日付入力欄：有効 | 日付入力欄：**無効** (JavaScript制御) |
| **登録先** | `DBA.hacflr` | `DBA.hacfl04` |
| **UIテーマ色** | 青 (`#007bff`) | 赤 (`#dc3545`) |

---

## 6. 画面遷移と処理フロー

### 6.1 TOP画面 (`/hacfl/`)
* **GET**: セッション初期化（BatchID破棄）。
* **POST (Action: single)**:
    1.  単発入力値を受け取る。
    2.  `insert_single_record` 実行。
    3.  エラーがあれば画面に表示、成功すればFlashメッセージを表示してリダイレクト。
* **POST (Action: csv)**:
    1.  CSVファイルと、一括指定用の日付を受け取る。
    2.  `parse_and_insert_work` 実行。
        * CSV解析、文字コード判定 (UTF-8/SJIS)。
        * `DBA.hacfl04_work` へINSERT (この時点ではエラー有無に関わらず全件登録)。
        * 古いワークデータの削除 (`updt` が当日より前のものを削除)。
    3.  成功時、`session['hacfl_batch_id']` を保存し、確認画面へリダイレクト。

### 6.2 確認画面 (`/hacfl/confirm`)
* **GET**:
    1.  `get_work_data_checked` 実行。
        * DB側で `exec_db_validation` を呼び出し、`err_msg` カラムを更新。
        * データをSELECTし、画面表示用に整形。
    2.  エラー行がある場合、本登録ボタンを非活性化（またはエラー表示）。
* **POST**:
    1.  `migrate_work_to_main` 実行。
        * `DBA.hacfl04_work` から、対象テーブル (`hacflr` or `hacfl04`) へ `INSERT ... SELECT`。
        * 部門コード(`bucd`)等は `DBA.comf204` から補完。
        * 登録完了後、ワークテーブルから該当BatchIDのデータを削除。
    2.  完了画面へリダイレクト。

### 6.3 完了画面 (`/hacfl/complete`)
* 登録件数とモードを表示し、TOPへ戻る導線を提供する。

### 6.4 API (非同期通信)
JavaScriptによる動的表示用エンドポイント。
* `/api/get_store_name`: 店舗CD → 店舗名
* `/api/get_product_info`: 商品CD → 商品詳細（品名、規格、入数、原単価等）
* `/api/check_mode_time`: モード選択時にサーバー時間での営業時間チェックを行う。

---

## 7. その他特記事項

* **ログ出力**: `common.logger` を使用し、単発登録・CSVアップロード・本登録の各タイミングで操作ログ（User ID含む）を記録する。
* **排他制御**: CSV登録は `batch_id` (UUID) によりセッション分離されているため、複数ユーザーが同時に作業してもデータは混在しない。
* **文字コード**: CSVは `UTF-8` および `Shift_JIS (cp932)` の両方に対応する。