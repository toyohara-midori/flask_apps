<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>滞留カゴ車登録</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}">
</head>
<body class="bg-light">
      <!-- ★★ tempo_base.html を include する★★ -->
    {% include 'tempo_base.html' %}
    <div class="container py-4">
	      <div class="title-area d-flex align-items-center gap-2">
          <h2 class="mb-4">滞留カゴ車登録</h2>
          <img src="{{ url_for('cart_stay_register.static', filename='img/usagi_tambourine.gif') }}">
        </div>

        <form method="post" action="{{ url_for('cart_stay_register.api_register_cart') }}">
            
        <div class="row mb-3 position-relative">
            <label class="col-sm-1 col-form-label" style=" min-width: 80px;">店舗CD</label>
            <div class="col-sm-3" style="position: relative;">
                <input id="cucd" name="cucd" type="text" maxlength="3"
                    value="{{ cucd or '' }}" placeholder="例: 123"
                    autocomplete="off"
                    inputmode="none"
                    style="ime-mode: disabled; text-transform: uppercase;"
                    class="form-control" />
                <div id="autocompleteList"
                    class="autocomplete-list border bg-white"
                    style="display:none; position:absolute; left:0; top:38px; width:100%; max-height:240px; overflow-y:auto; z-index:1000;">
                </div>
            </div>
            </div>

            <div class="row mb-3">
              <label class="col-sm-1 col-form-label" style=" min-width: 80px;">日付</label>
              <div class="col-sm-2">
                <input type="date" class="form-control" name="date" id="date" style=" min-width: 140px;"
                      value="{{ date or '' }}">
              </div>
              <div class="col-sm-3 ps-3">
                <span class="text-muted small" style="min-width: 400px; display: block;">※日付 Enter で、区分1～4に値が入ります</span>
              </div>
            </div>

            <div class="row mb-3">
                <label class="col-sm-1 col-form-label" style="min-width: 80px;">区分1</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control text-end" name="kubun1" id="kubun1" style="min-width: 60px;" value="{{ kubun1 or '' }}">
                </div>
                <div class="col-sm-4 d-flex align-items-center ps-3">
                    <span id="kubun1_desc" class="text-muted small" style="min-width: 400px;"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label class="col-sm-1 col-form-label" style=" min-width: 80px;">区分2</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control text-end" name="kubun2" id="kubun2" style="min-width: 60px;" value="{{ kubun2 or '' }}">
                </div>
                <div class="col-sm-4 d-flex align-items-center ps-3">
                    <span id="kubun2_desc" class="text-muted small" style="min-width: 400px;"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label class="col-sm-1 col-form-label" style=" min-width: 80px;">区分3</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control text-end" name="kubun3" id="kubun3" style="min-width: 60px;" value="{{ kubun3 or '' }}">
                </div>
                <div class="col-sm-4 d-flex align-items-center ps-3">
                    <span id="kubun3_desc" class="text-muted small" style="min-width: 400px;"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label class="col-sm-1 col-form-label" style=" min-width: 80px;">区分4</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control text-end" name="kubun4" id="kubun4" style="min-width: 60px;" value="{{ kubun4 or '' }}">
                </div>
                <div class="col-sm-4 d-flex align-items-center ps-3">
                    <span id="kubun4_desc" class="text-muted small" style="min-width: 400px;"></span>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-sm-6 d-flex gap-2">
                    <button id="btn-insert" type="submit" name="action" value="insert" class="btn btn-primary">登録</button>
                    <button id="btn-clear" type="button" class="btn btn-warning">クリア</button>
                </div>
            </div>

            <div id="msg" class="alert alert-info py-2" role="alert">
            {{ message or 'メッセージがここに表示されます。' }}
            </div>

        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

  const input = document.getElementById("cucd");
  const list = document.getElementById("autocompleteList");
  const cucdListUrl = "{{ url_for('cart_stay_register.api_cucd_list') }}";
  const chkCucdUrl = "{{ url_for('cart_stay_register.api_chk_cucd') }}";
  const regCartUrl = "{{ url_for('cart_stay_register.api_register_cart') }}";
  const chkDateUrl = "{{ url_for('cart_stay_register.api_check_date') }}";

// 60秒ごとにログイン状態をチェック
setInterval(async () => {
    try {
        const res = await fetch("/auth/check_session");
        const data = await res.json();

        if (!data.logged_in) {
            // ★ セッション切れ → ログインページへ飛ばす
            window.location.href = "/auth/login";
        }
    } catch (e) {
        console.error("セッションチェック失敗:", e);
    }
}, 60000); // 60秒

// 店舗CD入力オートコンプリート用処理
(async function() {
  let allItems = [];

  // ① 初期ロードで候補一覧を取得
  try {
    const res = await fetch(cucdListUrl);
    if (res.ok) allItems = await res.json();
  } catch (e) {
    console.error("候補取得失敗:", e);
  }

  // ② 入力イベント
  input.addEventListener("input", () => {
    // 全角→半角変換
    input.value = input.value.replace(/[！-～]/g, (s) =>
      String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
    );

    const val = input.value.trim();
    list.innerHTML = "";
    if (val.length === 0) {
      list.style.display = "none";
      return;
    }

    // 部分一致（前方一致）
    const matched = allItems.filter(x => x.startsWith(val));

    if (matched.length === 0) {
      list.style.display = "none";
      return;
    }

    matched.forEach(item => {
      const div = document.createElement("div");
      div.className = "autocomplete-item px-2 py-1";
      div.textContent = item;
      div.style.cursor = "pointer";
      div.addEventListener("click", async () => {
        const cd = item.substring(0, 3);
        input.value = cd;
        list.style.display = "none";

        // 店舗名確認API呼び出し
        try {
          const res = await fetch(chkCucdUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cucd: cd })
          });
          if (res.ok) {
            const j = await res.json();
            const msgBox = document.getElementById("msg");
            if (j.ok) {
              msgBox.textContent = `店舗CD ${j.cucd}（${j.nmkn}）`;
              msgBox.className = "alert alert-success py-2";
            } else {
              msgBox.textContent = j.msg || "正しい店舗CDを入力してください";
              msgBox.className = "alert alert-warning py-2";
            }
          }
        } catch (e) {
          console.warn("chk_cucd 呼び出し失敗:", e);
        }
      });
      list.appendChild(div);
    });

    list.scrollTop = 0;
    list.style.display = "block";
  });
 
  // ④ フォーカス外れたらリスト非表示
  document.addEventListener("click", (e) => {
    if (!list.contains(e.target) && e.target !== input) {
      list.style.display = "none";
    }
  });
})();

// 区分説明を取得してセット
async function loadCategoryDescriptions() {
  try {
    const res = await fetch("{{ url_for('cart_stay_register.api_category_list') }}");
    if (!res.ok) return;

    const data = await res.json();  
    // data = { "1": "区分1の説明", "2": "...", ... }

    document.getElementById("kubun1_desc").textContent = data["1"] || "";
    document.getElementById("kubun2_desc").textContent = data["2"] || "";
    document.getElementById("kubun3_desc").textContent = data["3"] || "";
    document.getElementById("kubun4_desc").textContent = data["4"] || "";

  } catch (e) {
    console.error("区分説明取得失敗:", e);
  }
}
document.addEventListener("DOMContentLoaded", loadCategoryDescriptions);

// メッセージ表示処理
function showMsg(text, type="info") {
  const msgBox = document.getElementById("msg");
  msgBox.textContent = text;
  msgBox.className = "alert py-2 alert-" + type;
}

// ② 日付選択後の処理
const dateInput = document.getElementById("date");

dateInput.addEventListener("blur", async () => {
  const cucdVal = document.getElementById("cucd").value.trim();
  const idleDate = dateInput.value;

  if (!cucdVal) {
    showMsg("店舗CDを先に入力してください。", "warning");
    return;
  }
  if (!idleDate) {
    showMsg("日付を選択してください。", "warning");
    return;
  }

  try {
    const res = await fetch(chkDateUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cucd: cucdVal, idleDate: idleDate })
    });

    const data = await res.json();
    if (!data.ok) {
      showMsg(data.msg || "データ取得に失敗しました。", "danger");
      return;
    }

    // cat値をフォームへ反映
    document.getElementById("kubun1").value = data.cat1 ?? 0;
    document.getElementById("kubun2").value = data.cat2 ?? 0;
    document.getElementById("kubun3").value = data.cat3 ?? 0;
    document.getElementById("kubun4").value = data.cat4 ?? 0;
    showMsg(data.msg, data.exists ? "warning" : "success");
  } catch (e) {
    console.error(e);
    showMsg("通信エラーが発生しました。", "danger");
  }
});

// ==========================================================
// 区分1〜4 入力チェック
// ==========================================================

["kubun1", "kubun2", "kubun3", "kubun4"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("blur", () => {
    const val = el.value.trim();
    const msgBox = document.getElementById("msg");

    // 空白 → 0を設定
    if (val === "") {
      el.value = 0;
      return;
    }

    // 数値変換できるか判定
    const num = Number(val);
    if (isNaN(num)) {
      msgBox.textContent = "数値で入力してください";
      msgBox.className = "alert alert-warning py-2";
      el.value = 0;
      el.focus();
      el.select();
      return;
    }

    // 範囲チェック（0〜999）
    if (num < 0 || num >= 1000) {
      msgBox.textContent = "0～999の間で入力してください";
      msgBox.className = "alert alert-warning py-2";
      el.focus();
      el.select();
      return;
    }

    // 正常時はメッセージを消す
    msgBox.textContent = "";
    msgBox.className = "alert py-2 alert-info";
  });

  // 入力時：数字以外は受け付けない（リアルタイム制御）
  el.addEventListener("input", () => {
    el.value = el.value.replace(/[^0-9]/g, ""); // 数字以外削除
  });
});

// ==========================================================
// 登録ボタンがフォーカス中に Enter でも動作するようにする
// ==========================================================
const btnInsert = document.getElementById("btn-insert");
btnInsert.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    btnInsert.click(); // ← クリックイベントを明示的に呼ぶ！
  }
});

// ==========================================================
// 登録ボタン押下時の処理
// ==========================================================
document.getElementById("btn-insert").addEventListener("click", async (e) => {
  e.preventDefault();

  const cucd = document.getElementById("cucd").value.trim();
  const date = document.getElementById("date").value;
  const cat1 = document.getElementById("kubun1").value.trim() || "0";
  const cat2 = document.getElementById("kubun2").value.trim() || "0";
  const cat3 = document.getElementById("kubun3").value.trim() || "0";
  const cat4 = document.getElementById("kubun4").value.trim() || "0";
  const msgBox = document.getElementById("msg");

  try {
    const res = await fetch(regCartUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cucd, idleDate: date, cat1, cat2, cat3, cat4 })
    });
    const data = await res.json();

    if (!data.ok) {
      msgBox.textContent = data.msg;
      msgBox.className = "alert alert-warning py-2";
      if (data.focus) document.getElementById(data.focus).focus();
      return;
    }

    msgBox.textContent = data.msg;
    msgBox.className = "alert alert-success py-2";
  } catch (e2) {
    msgBox.textContent = "通信エラーが発生しました。";
    msgBox.className = "alert alert-danger py-2";
  }
});

// ==========================================================
// クリアボタン押下時の処理
// ==========================================================
document.getElementById("btn-clear").addEventListener("click", () => {
  // 入力欄をすべてクリア
  document.getElementById("cucd").value = "";
  document.getElementById("date").value = "";
  document.getElementById("kubun1").value = "";
  document.getElementById("kubun2").value = "";
  document.getElementById("kubun3").value = "";
  document.getElementById("kubun4").value = "";

  // メッセージもクリア
  const msgBox = document.getElementById("msg");
  msgBox.textContent = "";
  msgBox.className = "alert py-2 alert-info";

  // 店舗CDにフォーカスを戻す
  const cucdInput = document.getElementById("cucd");
  cucdInput.focus();
});

// ==========================================================
// Enterキーで次の入力欄にフォーカスを移す制御
// ==========================================================

document.addEventListener("DOMContentLoaded", () => {
  const order = [
    "cucd",    // 店舗CD
    "date",    // 日付
    "kubun1",  // 区分1
    "kubun2",  // 区分2
    "kubun3",  // 区分3
    "kubun4",  // 区分4
    "btn-insert"  // 登録ボタン
  ];

  // 各要素を取得
  const elements = order.map(id => document.getElementById(id)).filter(e => e);

  // 全項目でEnter押下時の動作を統一
  elements.forEach((el, idx) => {
    el.addEventListener("keydown", async (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();

        // ----------------------------------------
        // 店舗CD欄の場合
        // ----------------------------------------
        if (el.id === "cucd") {
          const val = el.value.trim();
          const msgBox = document.getElementById("msg");
          document.getElementById("autocompleteList").style.display = "none";

          if (!/^\d{3}$/.test(val)) {
            msgBox.textContent = "店舗CDは3桁で入力してください";
            msgBox.className = "alert alert-warning py-2";
            el.focus();
            el.select();
            return; // ← 移動しない！
          }

          // APIチェック
          try {
            const res = await fetch(chkCucdUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ cucd: val })
            });
            const data = await res.json();
            if (!data.ok) {
              msgBox.textContent = data.msg || "正しい店舗CDを入力してください";
              msgBox.className = "alert alert-warning py-2";
              el.focus();
              el.select();
              return; // ← 移動しない！
            }
            msgBox.textContent = `店舗CD ${data.cucd}（${data.nmkn}）`;
            msgBox.className = "alert alert-success py-2";
          } catch (e) {
            msgBox.textContent = "店舗CD確認中にエラーが発生しました。";
            msgBox.className = "alert alert-danger py-2";
            el.focus();
            return; // ← 移動しない！
          }
        }

        // ----------------------------------------
        // 日付欄の場合
        // ----------------------------------------
        if (el.id === "date") {
          const cucdVal = document.getElementById("cucd").value.trim();
          const dateVal = el.value;
          const msgBox = document.getElementById("msg");

          if (!cucdVal) {
            msgBox.textContent = "店舗CDを先に入力してください。";
            msgBox.className = "alert alert-warning py-2";
            document.getElementById("cucd").focus();
            return;
          }

          if (!dateVal) {
            msgBox.textContent = "日付を正しく入力してください。";
            msgBox.className = "alert alert-warning py-2";
            el.focus();
            return;
          }

          // 入力された日付のDateオブジェクト作成
          const d = new Date(dateVal);

          // 日付が完全に正しいかチェック（例：2/31などを排除）
          const [yyyy, mm, dd] = dateVal.split("-").map(Number);
          if (
            d.getFullYear() !== yyyy ||
            (d.getMonth() + 1) !== mm ||
            d.getDate() !== dd
          ) {
            msgBox.textContent = "日付を正しく入力してください。";
            msgBox.className = "alert alert-warning py-2";
            el.focus();
            el.select();
            return;
          }

          // 今日・2年前の比較用に時刻をリセット
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const twoYearsAgo = new Date();
          twoYearsAgo.setFullYear(today.getFullYear() - 2);
          twoYearsAgo.setHours(0, 0, 0, 0);

          // 入力値の日付も時刻をリセット
          d.setHours(0, 0, 0, 0);

          // 未来日チェック
          if (d > today) {
            msgBox.textContent = "未来の日付は入力できません。";
            msgBox.className = "alert alert-warning py-2";
            el.focus();
            el.select();
            return;
          }

          // 2年前以上前チェック
          if (d < twoYearsAgo) {
            msgBox.textContent = "2年前以上の日付は入力できません。";
            msgBox.className = "alert alert-warning py-2";
            el.focus();
            el.select();
            return;
          }

          // DBチェック
          try {
            const res = await fetch(chkDateUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ cucd: cucdVal, idleDate: dateVal })
            });
            const data = await res.json();

            if (!data.ok) {
              msgBox.textContent = data.msg || "データ取得に失敗しました。";
              msgBox.className = "alert alert-danger py-2";
              el.focus();
              return;
            }

            document.getElementById("kubun1").value = data.cat1 ?? 0;
            document.getElementById("kubun2").value = data.cat2 ?? 0;
            document.getElementById("kubun3").value = data.cat3 ?? 0;
            document.getElementById("kubun4").value = data.cat4 ?? 0;
            msgBox.textContent = data.msg;
            msgBox.className = data.exists ? "alert alert-warning py-2" : "alert alert-success py-2";

          } catch (e) {
            msgBox.textContent = "日付確認中に通信エラーが発生しました。";
            msgBox.className = "alert alert-danger py-2";
            el.focus();
            return;
          }
        }

      // ----------------------------------------
      // 正常時だけ次の要素にフォーカス
      // ----------------------------------------
        const next = elements[idx + 1];
        if (next) {
          next.focus();
          if (next.select) next.select(); // テキストボックスなら選択
        }
      }
    });
  });

});
console.log("session check JS loaded");  // ★確認用
</script>
</body>

</html>