# 内部設計書：DC入庫発注データ取込システム

## 1. システム概要
本システムは、DC（ディストリビューションセンター）への入庫発注データをCSV形式でアップロードし、基幹システムの仕入テーブル（dcnyu03/04）および値引テーブル（dcneb）へ登録・管理するものである。

## 2. 画面構成 (Templates)
システムは以下の画面で構成される。

| 画面名 | ファイル名 | 概要 |
| :--- | :--- | :--- |
| **データ取込TOP** | `index.html` | CSVファイルのドラッグ＆ドロップによるアップロード、各メニューへの遷移。 |
| **取込内容確認** | `confirm.html` | CSV解析結果をセンター・納品日・ベンダー別にグルーピング表示。JV/定番の集計表示。 |
| **登録完了** | `complete.html` | 登録完了通知と、発行されたバッチIDの表示。 |
| **伝票一覧・検索** | `voucher_list.html` | 登録済みデータの検索、絞り込み、CSV/PDF出力指示。 |
| **伝票詳細** | `voucher_detail.html` | 特定伝票の明細表示。入数に基づくケース換算表示を含む。 |
| **上限数量管理** | `edit_limits.html` | センター別の日次入庫上限数の設定・参照、出荷予定との対比表示。 |
| **帳票印刷** | `print_list.html` | 仕入伝票（青）および値引伝票（赤）のA4印刷用レイアウト。 |

## 3. 業務ロジック (Python)

### 3.1. CSV解析・バリデーション (`dc_in_db_logic.py`)
- **バラ総数入力:** CSVの数量を「バラ総数」として読み込み、商品マスタ（comf204）の入数で除算してケース数を算出する。
- **整合性チェック:** 数量が入数で割り切れない場合はエラーとし、登録を中断させる。
- **マスタ参照:** 商品名、規格、メーカー名、部門、取引先名を各マスタから補完する。

### 3.2. 採番および登録処理 (`dc_in_db_logic.py`)
- **伝票分割:** 1つの伝票につき最大6行までとし、超過分は自動的に新しい伝票番号を発行して分割する。
- **排他制御:** `DBA.excluflg` を使用したセマフォ方式のロック制御を行い、複数ユーザーによる同時採番時の番号重複を防止する。
- **二重登録防止:** ワークテーブル（`DC_IN_CSV`）を利用し、確認画面から確定ボタンが押された際のみ本番テーブルへ書き込む。
- **ログ記録:** `DBA.dc_batch_log` に実行バッチIDと生成された全伝票番号の紐付けを記録し、後追いを可能にする。

### 3.3. 権限管理 (`__init__.py`)
- **AD連携:** `Domain Admins`、`G-商品部ディストリビューター`、`G-商品部バイヤー` のいずれかのグループに所属するユーザーのみアクセスを許可する。

## 4. データ構造 (DB)

### 4.1. 主要利用テーブル
| テーブル名 | 用途 |
| :--- | :--- |
| `DBA.dcnyu03 / 04` | 守谷C / 狭山日高C の仕入データ（本番） |
| `DBA.dcneb` | 値引伝票データ |
| `DBA.dc_batch_log` | アップロードバッチ単位の履歴管理 |
| `DBA.dc_limit_master` | センター別入庫上限設定 |
| `DC_IN_CSV` | アップロード時の一時ワークテーブル |
| `DBA.ctlmf / henctlmf` | 伝票番号管理（カウンタ） |

## 5. 処理フロー

### 5.1. データ取込フロー
1.  **CSV選択:** ユーザーが `index.html` にファイルをD&D。
2.  **解析:** `process_upload_csv` が形式とマスタ整合性をチェック。
3.  **一時保存:** 正常データのみ `DC_IN_CSV` に保存。
4.  **確認:** `confirm.html` でグルーピングされた内容を表示。
5.  **確定:** `insert_voucher_data` が起動。
    -   `excluflg` ロック取得
    -   `ctlmf` から番号取得・更新
    -   `dcnyuXX` / `dcneb` へINSERT
    -   `dc_batch_log` へ履歴保存
    -   ロック解除

### 5.2. 帳票出力フロー
1.  **選択:** `voucher_list.html` で対象伝票をチェック。
2.  **データ生成:** `get_related_discount_vouchers` で仕入伝票に紐づく値引伝票（赤伝）を自動抽出。
3.  **レンダリング:** `print_list.html` のマクロにより、1ページに仕入・値引がセットで並ぶようレイアウト。