<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DCå…¥è·ä¼ç¥¨ä¸€è¦§</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ */
        .filter-area {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

            .filter-group label {
                font-size: 11px;
                font-weight: bold;
                margin-bottom: 3px;
            }

            .filter-group select {
                padding: 2px;
                height: 28px;
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        .id-select {
            border: 2px solid #007bff;
            background-color: #eef;
        }

        .toggle-btn-group {
            display: flex;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            height: 28px;
        }

            .toggle-btn-group label {
                padding: 4px 10px;
                font-size: 12px;
                cursor: pointer;
                border-right: 1px solid #ccc;
                background: #fff;
                color: #333;
                display: flex;
                align-items: center;
            }

                .toggle-btn-group label:last-child {
                    border-right: none;
                }

            .toggle-btn-group input[type="radio"] {
                display: none;
            }

                .toggle-btn-group input[type="radio"]:checked + label {
                    background-color: #007bff;
                    color: white;
                }

        .date-control {
            display: flex;
            align-items: center;
            height: 28px;
        }

            .date-control input[type="text"] {
                width: 90px;
                text-align: center;
                padding: 2px;
                height: 100%;
                border: 1px solid #ccc;
                border-left: none;
                border-right: none;
                font-size: 13px;
            }

        .date-btn {
            width: 25px;
            height: 100%;
            padding: 0;
            background: #e0e0e0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-weight: bold;
        }

            .date-btn:first-child {
                border-radius: 4px 0 0 4px;
            }

            .date-btn:last-child {
                border-radius: 0 4px 4px 0;
            }

        button.primary, button.reset {
            padding: 4px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            height: 28px;
            font-size: 13px;
            color: white;
        }

        button.primary {
            background-color: #007bff;
        }

        button.reset {
            background-color: #6c757d;
        }

        .export-area {
            text-align: right;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .export-btn {
            padding: 5px 12px;
            text-decoration: none;
            color: white;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
            display: inline-block;
        }

        .csv-btn {
            background-color: #28a745;
        }

        .pdf-btn {
            background-color: #dc3545;
        }

        /* --- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« --- */
        table {
            width: auto;
            max-width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 13px;
            margin-left: auto;
            margin-right: auto;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 4px 8px;
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
        }

        th {
            background-color: #f2f2f2;
            text-align: center;
            user-select: none;
        }

            th.sortable {
                cursor: pointer;
                color: #0056b3;
            }

                th.sortable:hover {
                    background-color: #e2e6ea;
                }

        .sort-icon {
            font-size: 0.8em;
            margin-left: 3px;
            color: #d35400;
        }

        .text-center {
            text-align: center;
        }

        .check-col {
            width: 30px;
            text-align: center;
        }

            .check-col input {
                cursor: pointer;
            }

        .print-voucher-area {
            width: fit-content;
            margin: 15px auto;
            padding: 10px 30px;
            background-color: #eef;
            border: 1px solid #ccc;
            text-align: center;
            border-radius: 5px;
        }

        .print-btn {
            padding: 8px 20px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }

            .print-btn:hover {
                background-color: #138496;
            }

        a {
            text-decoration: none;
            color: #0066cc;
            cursor: pointer;
        }

        .id-search {
            margin-bottom: 5px;
            text-align: right;
        }

        /* â˜…è¿½åŠ : åˆè¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .summary-area {
            float: right;
            background-color: #fff;
            border: 2px solid #28a745;
            padding: 5px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-item {
            margin-left: 15px;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .summary-val {
            font-size: 18px;
            color: #d35400;
            margin-left: 5px;
        }

        /* â˜…è¿½åŠ : è¡¨å†…ã®çµã‚Šè¾¼ã¿ãƒªãƒ³ã‚¯ç”¨ */
        .drilldown-link {
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
        }

            .drilldown-link:hover {
                color: #003366;
                background-color: #e6f2ff;
            }
    </style>
    <script>
        function openDetailWindow(url) {
            const width = 1000; const height = 800;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            window.open(url, 'VoucherDetailWindow', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`);
        }
        function toggleAll(source) {
            checkboxes = document.getElementsByName('v_ids');
            for (var i = 0, n = checkboxes.length; i < n; i++) checkboxes[i].checked = source.checked;
        }
        function changeDate(delta) {
            const input = document.querySelector('input[name="delivery_date"]');
            const val = input.value;
            if (!val) return;
            const d = new Date(val);
            if (isNaN(d.getTime())) return;
            d.setDate(d.getDate() + delta);
            const y = d.getFullYear();
            const m = ('00' + (d.getMonth() + 1)).slice(-2);
            const day = ('00' + d.getDate()).slice(-2);
            input.value = `${y}/${m}/${day}`;
        }

        function submitListCsv() {
            const form = document.querySelector('form[action*="download_voucher_pdf"]');
            if (!form) { alert("ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }
            const checkboxes = form.querySelectorAll('input[name="v_ids"]:checked');
            if (checkboxes.length === 0) { alert("å‡ºåŠ›ã™ã‚‹ä¼ç¥¨ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚"); return; }
            const originalAction = form.action;
            form.action = "{{ url_for('dc_in.download_csv') }}";
            form.submit();
            setTimeout(() => { form.action = originalAction; }, 100);
        }

        function submitListPdf() {
            const form = document.querySelector('form[action*="download_voucher_pdf"]');
            if (!form) { alert("ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
            const checkboxes = form.querySelectorAll('input[name="v_ids"]:checked');
            if (checkboxes.length === 0) { alert("å‡ºåŠ›ã™ã‚‹ä¼ç¥¨ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚"); return; }
            const originalAction = form.action;
            form.action = "{{ url_for('dc_in.print_list') }}";
            form.submit();
            setTimeout(() => { form.action = originalAction; }, 100);
        }

        function applySort(colName) {
            const form = document.querySelector('form.filter-area');
            const sortInput = form.querySelector('input[name="sort"]');
            const orderInput = form.querySelector('input[name="order"]');
            if (sortInput.value === colName) {
                orderInput.value = (orderInput.value === 'asc') ? 'desc' : 'asc';
            } else {
                sortInput.value = colName;
                orderInput.value = 'asc';
            }
            form.submit();
        }

        function addFilter(key, value) {
            if (!value) return;
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set(key, value);
            window.location.search = urlParams.toString();
        }

        function resetFiltersKeepDate() {
            const urlParams = new URLSearchParams(window.location.search);
            const dateVal = urlParams.get('delivery_date');
            const newParams = new URLSearchParams();
            if (dateVal) {
                newParams.set('delivery_date', dateVal);
            }
            window.location.search = newParams.toString();
        }

        function resetAll() {
            window.location.href = "{{ url_for('dc_in.voucher_list') }}";
        }

        /**
         * â˜…å¤‰æ›´: ãƒãƒƒãƒIDé¸æŠæ™‚ã¯ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’å…¨ã‚¯ãƒªã‚¢ã—ã¦é€ä¿¡
         */
        function onBatchChange(select) {
            const form = select.form;

            // 1. æ—¥ä»˜ã‚’ã‚¯ãƒªã‚¢
            const dateInput = form.querySelector('input[name="delivery_date"]');
            if (dateInput) dateInput.value = "";

            // 2. ã‚»ãƒ³ã‚¿ãƒ¼ã‚’ã€Œå…¨ã¦ã€ã« (value=""ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’é¸æŠ)
            const centerRadios = form.querySelectorAll('input[name="center"]');
            for (const radio of centerRadios) {
                if (radio.value === "") {
                    radio.checked = true;
                    break;
                }
            }

            // 3. éƒ¨é–€ã‚’ã€Œå…¨ã¦ã€ã«
            const deptSelect = form.querySelector('select[name="dept"]');
            if (deptSelect) deptSelect.value = "";

            // 4. å–å¼•å…ˆã‚’ã€Œå…¨ã¦ã€ã«
            const vendorSelect = form.querySelector('select[name="vendor"]');
            if (vendorSelect) vendorSelect.value = "";

            // 5. ç¨®åˆ¥ã‚’ã€Œå…¨ã¦ã€ã«
            const typeRadios = form.querySelectorAll('input[name="type"]');
            for (const radio of typeRadios) {
                if (radio.value === "all") {
                    radio.checked = true;
                    break;
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            form.submit();
        }
    </script>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px;">
        <h3 style="margin: 0;">DCå…¥è·ä¼ç¥¨ä¸€è¦§</h3>

        <div class="summary-area">
            <span>åˆè¨ˆäºˆå®šæ•°:</span>
            <span class="summary-item">å®ˆè°·C <span class="summary-val">{{ "{:,}".format(summary.moriya) }}</span> cs</span>
            <span class="summary-item">ç‹­å±±æ—¥é«˜C <span class="summary-val">{{ "{:,}".format(summary.sayama) }}</span> cs</span>
        </div>
    </div>

    <div class="id-search">
        <form method="POST" style="display:inline;" target="_blank">
            <input type="text" name="voucher_id" placeholder="ä¾‹: 600101" required style="padding:2px 5px; font-size:13px;">
            <button type="submit" class="primary">ç•ªå·æ¤œç´¢</button>
        </form>
        {% if error %}<span style="color:red; margin-left:10px; font-size:13px;">{{ error }}</span>{% endif %}
    </div>

    <form method="GET" class="filter-area">
        <input type="hidden" name="sort" value="{{ current_filters.sort }}">
        <input type="hidden" name="order" value="{{ current_filters.order }}">

        <div class="filter-group">
            <label style="color: #007bff;">ğŸ“‚ å—ä»˜ç•ªå·ID (å±¥æ­´)</label>
            <select name="batch_id" class="id-select" onchange="onBatchChange(this)">
                <option value="">å…¨ã¦è¡¨ç¤º</option>
                {% for b in batch_options %}
                <option value="{{ b.val }}" {% if current_filters.batch_id==b.val %}selected{% endif %}>
                    {{ b.text }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>ç´å“æ—¥</label>
            <div class="date-control">
                <button type="button" class="date-btn" onclick="changeDate(-1)">ï¼œ</button>
                <input type="text" name="delivery_date" value="{{ current_filters.delivery_date }}">
                <button type="button" class="date-btn" onclick="changeDate(1)">ï¼</button>
            </div>
        </div>
        <div class="filter-group">
            <label>ã‚»ãƒ³ã‚¿ãƒ¼</label>
            <div class="toggle-btn-group">
                <input type="radio" name="center" value="" id="c_all" {% if not current_filters.center %}checked{% endif %}>
                <label for="c_all">å…¨ã¦</label>
                {% for c in centers %}
                <input type="radio" name="center" value="{{ c }}" id="c_{{ loop.index }}" {% if current_filters.center==c %}checked{% endif %}>
                <label for="c_{{ loop.index }}">{{ c }}</label>
                {% endfor %}
            </div>
        </div>
        <div class="filter-group">
            <label>éƒ¨é–€</label>
            <select name="dept" style="max-width: 180px;">
                <option value="">å…¨ã¦</option>
                {% for d in depts %}
                <option value="{{ d.code }}" {% if current_filters.dept==d.code %}selected{% endif %}>
                    {{ d.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>å–å¼•å…ˆ</label>
            <select name="vendor" style="max-width: 220px;">
                <option value="">å…¨ã¦</option>
                {% for v in vendors %}
                <option value="{{ v.code }}" {% if current_filters.vendor==v.code %}selected{% endif %}>
                    {{ v.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>ç¨®åˆ¥</label>
            <div class="toggle-btn-group">
                <input type="radio" name="type" value="all" id="t_all" {% if not current_filters.type or current_filters.type=='all' %}checked{% endif %}>
                <label for="t_all">å…¨ã¦</label>
                <input type="radio" name="type" value="regular" id="t_reg" {% if current_filters.type=='regular' %}checked{% endif %}>
                <label for="t_reg">å®šç•ª</label>
                <input type="radio" name="type" value="jv" id="t_jv" {% if current_filters.type=='jv' %}checked{% endif %}>
                <label for="t_jv">JV</label>
            </div>
        </div>

        <div class="filter-group" style="align-self: flex-end; flex-direction: row; align-items: flex-end;">
            <button type="submit" class="primary" style="margin-right: 20px;">çµã‚Šè¾¼ã¿</button>

            <button type="button" class="reset" onclick="resetFiltersKeepDate()"
                    {% if not current_filters.delivery_date %}
                    disabled style="margin-right: 5px; background-color: #ccc; cursor: not-allowed;"
                    {% else %}
                    style="margin-right: 5px; background-color: #17a2b8;"
                    {% endif %}>
                æ—¥ä»˜ç¶­æŒãƒªã‚»ãƒƒãƒˆ
            </button>

            <button type="button" class="reset" onclick="resetAll()">
                å…¨ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </form>

    <div class="export-area" style="width: 95%; margin: 0 auto; margin-bottom: 5px;">
        <span>ãƒã‚§ãƒƒã‚¯ã—ãŸãƒªã‚¹ãƒˆã‚’å‡ºåŠ›:</span>
        <button type="button" onclick="submitListCsv()" class="export-btn csv-btn" style="border:none; cursor:pointer;">
            ğŸ“¥ ä¸€è¦§CSV
        </button>

        <button type="button" onclick="submitListPdf()" class="export-btn pdf-btn" style="border:none; cursor:pointer;">
            ğŸ“„ ä¸€è¦§PDF
        </button>
    </div>

    <form method="POST" action="{{ url_for('dc_in.download_voucher_pdf') }}" target="_blank">
        <table>
            <thead>
                <tr>
                    <th class="check-col"><input type="checkbox" onclick="toggleAll(this)"></th>

                    <th class="sortable" onclick="applySort('batch_id')">
                        å—ä»˜ç•ªå·ID
                        {% if current_filters.sort == 'batch_id' %}
                        <span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>
                        {% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('voucher_id')">
                        ä¼ç¥¨ç•ªå·
                        {% if current_filters.sort == 'voucher_id' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('dept_code')">
                        éƒ¨é–€
                        {% if current_filters.sort == 'dept_code' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('dept_name')">
                        éƒ¨é–€å
                        {% if current_filters.sort == 'dept_name' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('center')">
                        ã‚»ãƒ³ã‚¿ãƒ¼
                        {% if current_filters.sort == 'center' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('delivery_date')">
                        ç´å“æ—¥
                        {% if current_filters.sort == 'delivery_date' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('vendor_code')">
                        ãƒ™ãƒ³ãƒ€ãƒ¼
                        {% if current_filters.sort == 'vendor_code' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('vendor')">
                        å–å¼•å…ˆ
                        {% if current_filters.sort == 'vendor' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('p_name')">
                        å“å (1è¡Œç›®)
                        {% if current_filters.sort == 'p_name' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('manufacturer')">
                        ãƒ¡ãƒ¼ã‚«ãƒ¼
                        {% if current_filters.sort == 'manufacturer' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for info in vouchers %}
                <tr>
                    <td class="check-col"><input type="checkbox" name="v_ids" value="{{ info.voucher_id }}"></td>

                    <td class="text-center" style="font-size:0.8em; color:#666;" title="{{ info.batch_id }}">
                        {{ info.batch_id[:8] }}...
                    </td>

                    <td class="text-center">
                        <a href="#" onclick="openDetailWindow('{{ url_for('dc_in.voucher_detail', v_id=info.voucher_id) }}'); return false;">
                            <strong>{{ info.voucher_id }}</strong>
                        </a>
                    </td>

                    <td class="text-center">
                        <span class="drilldown-link" onclick="addFilter('dept', '{{ info.dept_code }}')" title="ã“ã®éƒ¨é–€ã§çµã‚Šè¾¼ã‚€">
                            {{ info.dept_code }}
                        </span>
                    </td>
                    <td>{{ info.dept_name }}</td>

                    <td class="text-center">
                        <span class="drilldown-link" onclick="addFilter('center', '{{ info.center_code }}')" title="ã“ã®ã‚»ãƒ³ã‚¿ãƒ¼ã§çµã‚Šè¾¼ã‚€">
                            {{ info.center }}
                        </span>
                    </td>
                    <td class="text-center">{{ info.delivery_date }}</td>

                    <td class="text-center">
                        <span class="drilldown-link" onclick="addFilter('vendor', '{{ info.vendor_code }}')" title="ã“ã®å–å¼•å…ˆã§çµã‚Šè¾¼ã‚€">
                            {{ info.vendor_code }}
                        </span>
                    </td>
                    <td>{{ info.vendor }}</td>

                    <td>{{ info.first_p_name }}</td>
                    <td>{{ info.manufacturer }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="print-voucher-area">
            <button type="submit" class="print-btn">ğŸ–¨ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸä¼ç¥¨ã®å¸³ç¥¨(PDF)ã‚’å‡ºåŠ›ã™ã‚‹</button>
        </div>
    </form>

    <br>
    <div style="text-align: center;">
        <a href="{{ url_for('dc_in.home') }}">ãƒˆãƒƒãƒ—(ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢)ã¸æˆ»ã‚‹</a>
    </div>
</body>
</html>