<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DCå…¥è·ä¼ç¥¨ä¸€è¦§</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ */
        .filter-area {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

            .filter-group label {
                font-size: 11px;
                font-weight: bold;
                margin-bottom: 3px;
            }

            .filter-group select {
                padding: 2px;
                height: 28px;
                font-size: 13px;
            }

        .id-select {
            border: 2px solid #007bff;
            background-color: #eef;
        }

        .toggle-btn-group {
            display: flex;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            height: 28px;
        }

            .toggle-btn-group label {
                padding: 4px 10px;
                font-size: 12px;
                cursor: pointer;
                border-right: 1px solid #ccc;
                background: #fff;
                color: #333;
                display: flex;
                align-items: center;
            }

                .toggle-btn-group label:last-child {
                    border-right: none;
                }

            .toggle-btn-group input[type="radio"] {
                display: none;
            }

                .toggle-btn-group input[type="radio"]:checked + label {
                    background-color: #007bff;
                    color: white;
                }

        .date-control {
            display: flex;
            align-items: center;
            height: 28px;
        }

            .date-control input[type="text"] {
                width: 90px;
                text-align: center;
                padding: 2px;
                height: 100%;
                border: 1px solid #ccc;
                border-left: none;
                border-right: none;
                font-size: 13px;
            }

        .date-btn {
            width: 25px;
            height: 100%;
            padding: 0;
            background: #e0e0e0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-weight: bold;
        }

            .date-btn:first-child {
                border-radius: 4px 0 0 4px;
            }

            .date-btn:last-child {
                border-radius: 0 4px 4px 0;
            }

        button.primary, button.reset {
            padding: 4px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            height: 28px;
            font-size: 13px;
            color: white;
        }

        button.primary {
            background-color: #007bff;
        }

        button.reset {
            background-color: #6c757d;
        }

        .export-area {
            text-align: right;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .export-btn {
            padding: 5px 12px;
            text-decoration: none;
            color: white;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
            display: inline-block;
        }

        .csv-btn {
            background-color: #28a745;
        }

        .pdf-btn {
            background-color: #dc3545;
        }

        /* --- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« --- */
        table {
            width: auto;
            max-width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 13px;
            margin-left: auto;
            margin-right: auto;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 4px 8px;
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚½ãƒ¼ãƒˆå¯èƒ½ãªåˆ—ã¯ãƒã‚¤ãƒ³ã‚¿ã‚«ãƒ¼ã‚½ãƒ«ã« */
        th {
            background-color: #f2f2f2;
            text-align: center;
            user-select: none;
        }

            th.sortable {
                cursor: pointer;
                color: #0056b3;
            }

                th.sortable:hover {
                    background-color: #e2e6ea;
                }

        /* ã‚½ãƒ¼ãƒˆçŸ¢å°ã®è‰² */
        .sort-icon {
            font-size: 0.8em;
            margin-left: 3px;
            color: #d35400;
        }

        .text-center {
            text-align: center;
        }

        .check-col {
            width: 30px;
            text-align: center;
        }

            .check-col input {
                cursor: pointer;
            }

        .print-voucher-area {
            width: fit-content;
            margin: 15px auto;
            padding: 10px 30px;
            background-color: #eef;
            border: 1px solid #ccc;
            text-align: center;
            border-radius: 5px;
        }

        .print-btn {
            padding: 8px 20px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }

            .print-btn:hover {
                background-color: #138496;
            }

        a {
            text-decoration: none;
            color: #0066cc;
            cursor: pointer;
        }

        .id-search {
            margin-bottom: 5px;
            text-align: right;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢å†…ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å…±é€šè¨­å®š */
        .filter-group select {
            padding: 2px;
            height: 28px;
            font-size: 13px;
            /* ä»¥ä¸‹ã‚’è¿½åŠ : æ–‡å­—ãŒé•·ã™ãã‚‹å ´åˆã« ... ã§çœç•¥ã™ã‚‹ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <script>
        function openDetailWindow(url) {
            const width = 1000; const height = 800;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            window.open(url, 'VoucherDetailWindow', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`);
        }
        function toggleAll(source) {
            checkboxes = document.getElementsByName('v_ids');
            for (var i = 0, n = checkboxes.length; i < n; i++) checkboxes[i].checked = source.checked;
        }
        function changeDate(delta) {
            const input = document.querySelector('input[name="delivery_date"]');
            const val = input.value;
            if (!val) return;
            const d = new Date(val);
            if (isNaN(d.getTime())) return;
            d.setDate(d.getDate() + delta);
            const y = d.getFullYear();
            const m = ('00' + (d.getMonth() + 1)).slice(-2);
            const day = ('00' + d.getDate()).slice(-2);
            input.value = `${y}/${m}/${day}`;
        }
        // â˜…è¿½åŠ ï¼šä¸€è¦§CSVãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        function submitListCsv() {
            const form = document.querySelector('form[action*="download_voucher_pdf"]');

            if (!form) {
                alert("ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            const checkboxes = form.querySelectorAll('input[name="v_ids"]:checked');
            if (checkboxes.length === 0) {
                alert("å‡ºåŠ›ã™ã‚‹ä¼ç¥¨ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
                return;
            }

            const originalAction = form.action;
            const originalTarget = form.target; // targetã‚‚ä¿å­˜ã—ã¦ãŠã

            // CSVã¯ç”»é¢é·ç§»ã›ãšãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ãŸã„ã®ã§ã€targetã‚’ä¸€æ™‚çš„ã«å¤–ã™æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€
            // ä»Šã®è¨­å®š(target="_blank")ã®ã¾ã¾ã§ã‚‚ã€Œæ–°ã—ã„ã‚¿ãƒ–ãŒé–‹ã„ã¦ã™ãé–‰ã˜ã‚‹ï¼†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã€ã«ãªã‚‹ã®ã§
            // ãã®ã¾ã¾ã®æ–¹ãŒå®‰å…¨ã§ã™ã€‚

            // é€ä¿¡å…ˆã‚’CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤‰æ›´
            form.action = "{{ url_for('dc_in.download_csv') }}";

            form.submit();

            // å¾Œå§‹æœ«
            setTimeout(() => {
                form.action = originalAction;
            }, 100);
        }

        // â˜…è¿½åŠ ï¼šä¸€è¦§PDFãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        function submitListPdf() {
            // 1. ãƒ•ã‚©ãƒ¼ãƒ ã‚’å–å¾— (nameå±æ€§ãŒãªã„ã®ã§ document.querySelectorã§å–å¾—)
            // ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å›²ã‚“ã§ã„ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ¢ã™
            const form = document.querySelector('form[action*="download_voucher_pdf"]');

            if (!form) {
                alert("ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            // 2. ãƒã‚§ãƒƒã‚¯ãŒã¤ã„ã¦ã„ã‚‹ã‹ç¢ºèª
            const checkboxes = form.querySelectorAll('input[name="v_ids"]:checked');
            if (checkboxes.length === 0) {
                alert("å‡ºåŠ›ã™ã‚‹ä¼ç¥¨ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
                return;
            }

            // 3. é€ä¿¡å…ˆã‚’ä¸€æ™‚çš„ã«ã€Œprint_listã€ã«å¤‰æ›´
            const originalAction = form.action; // å…ƒã®URL(å¸³ç¥¨ç”¨)ã‚’ä¿å­˜
            form.action = "{{ url_for('dc_in.print_list') }}";

            // 4. é€ä¿¡ï¼(åˆ¥ã‚¿ãƒ–ã§é–‹ãè¨­å®šã¯ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢ã«ã‚ã‚‹ã¯ãš)
            form.submit();

            // 5. é€ä¿¡å…ˆã‚’å…ƒã«æˆ»ã™ (ã“ã‚Œã‚’ã—ãªã„ã¨ä¸‹ã®ãƒœã‚¿ãƒ³ã‚‚ä¸€è¦§å°åˆ·ã«ãªã£ã¡ã‚ƒã†)
            setTimeout(() => {
                form.action = originalAction;
            }, 100);
        }
        // â˜…è¿½åŠ : ã‚½ãƒ¼ãƒˆå®Ÿè¡Œç”¨é–¢æ•°
        function applySort(colName) {
            const form = document.querySelector('form.filter-area');
            const sortInput = form.querySelector('input[name="sort"]');
            const orderInput = form.querySelector('input[name="order"]');

            // ç¾åœ¨ã¨åŒã˜ã‚«ãƒ©ãƒ ãªã‚‰é †åºã‚’åè»¢ã€é•ã†ãªã‚‰æ˜‡é †ã§ã‚»ãƒƒãƒˆ
            if (sortInput.value === colName) {
                orderInput.value = (orderInput.value === 'asc') ? 'desc' : 'asc';
            } else {
                sortInput.value = colName;
                orderInput.value = 'asc';
            }
            form.submit();
        }
    </script>
</head>
<body>

    <h3 style="margin: 10px 0;">DCå…¥è·ä¼ç¥¨ä¸€è¦§</h3>

    <div class="id-search">
        <form method="POST" style="display:inline;" target="_blank">

            <input type="text" name="voucher_id" placeholder="ä¾‹: 600101" required style="padding:2px 5px; font-size:13px;">
            <button type="submit" class="primary">ç•ªå·æ¤œç´¢</button>
        </form>
        {% if error %}<span style="color:red; margin-left:10px; font-size:13px;">{{ error }}</span>{% endif %}
    </div>

    <form method="GET" class="filter-area">
        <input type="hidden" name="sort" value="{{ current_filters.sort }}">
        <input type="hidden" name="order" value="{{ current_filters.order }}">

        <div class="filter-group">
            <label style="color: #007bff;">ğŸ“‚ å–è¾¼ID</label>
            <select name="import_id" class="id-select" onchange="this.form.submit()">
                <option value="">å…¨ã¦è¡¨ç¤º</option>
                {% for i_id in import_ids %}
                <option value="{{ i_id }}" {% if current_filters.import_id==i_id %}selected{% endif %}>{{ i_id }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>ç´å“æ—¥</label>
            <div class="date-control">
                <button type="button" class="date-btn" onclick="changeDate(-1)">ï¼œ</button>
                <input type="text" name="delivery_date" value="{{ default_date }}">
                <button type="button" class="date-btn" onclick="changeDate(1)">ï¼</button>
            </div>
        </div>
        <div class="filter-group">
            <label>ã‚»ãƒ³ã‚¿ãƒ¼</label>
            <div class="toggle-btn-group">
                <input type="radio" name="center" value="" id="c_all" {% if not current_filters.center %}checked{% endif %}>
                <label for="c_all">å…¨ã¦</label>
                {% for c in centers %}
                <input type="radio" name="center" value="{{ c }}" id="c_{{ loop.index }}" {% if current_filters.center==c %}checked{% endif %}>
                <label for="c_{{ loop.index }}">{{ c }}</label>
                {% endfor %}
            </div>
        </div>
        <div class="filter-group">
            <label>éƒ¨é–€</label>
            <select name="dept" style="max-width: 180px;">
                <option value="">å…¨ã¦</option>
                {% for d in depts %}
                <option value="{{ d.code }}" {% if current_filters.dept==d.code %}selected{% endif %}>
                    {{ d.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>å–å¼•å…ˆ</label>
            <select name="vendor" style="max-width: 220px;">
                <option value="">å…¨ã¦</option>
                {% for v in vendors %}
                <option value="{{ v.code }}" {% if current_filters.vendor==v.code %}selected{% endif %}>
                    {{ v.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>ç¨®åˆ¥</label>
            <div class="toggle-btn-group">
                <input type="radio" name="type" value="all" id="t_all" {% if not current_filters.type or current_filters.type=='all' %}checked{% endif %}>
                <label for="t_all">å…¨ã¦</label>
                <input type="radio" name="type" value="regular" id="t_reg" {% if current_filters.type=='regular' %}checked{% endif %}>
                <label for="t_reg">å®šç•ª</label>
                <input type="radio" name="type" value="jv" id="t_jv" {% if current_filters.type=='jv' %}checked{% endif %}>
                <label for="t_jv">JV</label>
            </div>
        </div>
        <button type="submit" class="primary">çµã‚Šè¾¼ã¿</button>
        <button type="button" class="reset" onclick="location.href='{{ url_for('dc_in.voucher_list') }}'">ãƒªã‚»ãƒƒãƒˆ</button>
    </form>

    <div class="export-area" style="width: 95%; margin: 0 auto; margin-bottom: 5px;">
        <span>ãƒã‚§ãƒƒã‚¯ã—ãŸãƒªã‚¹ãƒˆã‚’å‡ºåŠ›:</span> <button type="button" onclick="submitListCsv()" class="export-btn csv-btn" style="border:none; cursor:pointer;">
            ğŸ“¥ ä¸€è¦§CSV
        </button>

        <button type="button" onclick="submitListPdf()" class="export-btn pdf-btn" style="border:none; cursor:pointer;">
            ğŸ“„ ä¸€è¦§PDF
        </button>
    </div>

    <form method="POST" action="{{ url_for('dc_in.download_voucher_pdf') }}" target="_blank">
        <table>
            <thead>
                <tr>
                    <th class="check-col"><input type="checkbox" onclick="toggleAll(this)"></th>

                    <th class="sortable" onclick="applySort('import_id')">
                        å–è¾¼ID
                        {% if current_filters.sort == 'import_id' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('voucher_id')">
                        ä¼ç¥¨ç•ªå·
                        {% if current_filters.sort == 'voucher_id' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('dept_code')">
                        éƒ¨é–€
                        {% if current_filters.sort == 'dept_code' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('dept_name')">
                        éƒ¨é–€å
                        {% if current_filters.sort == 'dept_name' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('center')">
                        ã‚»ãƒ³ã‚¿ãƒ¼
                        {% if current_filters.sort == 'center' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('delivery_date')">
                        ç´å“æ—¥
                        {% if current_filters.sort == 'delivery_date' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('vendor_code')">
                        ãƒ™ãƒ³ãƒ€ãƒ¼
                        {% if current_filters.sort == 'vendor_code' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('vendor')">
                        å–å¼•å…ˆ
                        {% if current_filters.sort == 'vendor' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('p_name')">
                        å“å (1è¡Œç›®)
                        {% if current_filters.sort == 'p_name' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>

                    <th class="sortable" onclick="applySort('manufacturer')">
                        ãƒ¡ãƒ¼ã‚«ãƒ¼
                        {% if current_filters.sort == 'manufacturer' %}<span class="sort-icon">{{ 'â–²' if current_filters.order == 'asc' else 'â–¼' }}</span>{% endif %}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for info in vouchers %}
                <tr>
                    <td class="check-col"><input type="checkbox" name="v_ids" value="{{ info.voucher_id }}"></td>

                    <td class="text-center" style="font-size:0.8em; color:#666;">{{ info.import_id }}</td>

                    <td class="text-center">
                        <a href="#" onclick="openDetailWindow('{{ url_for('dc_in.voucher_detail', v_id=info.voucher_id) }}'); return false;">
                            <strong>{{ info.voucher_id }}</strong>
                        </a>
                    </td>

                    <td class="text-center">{{ info.dept_code }}</td>
                    <td>{{ info.dept_name }}</td>

                    <td class="text-center">{{ info.center }}</td>
                    <td class="text-center">{{ info.delivery_date }}</td>

                    <td class="text-center">{{ info.vendor_code }}</td>
                    <td>{{ info.vendor }}</td>

                    <td>{{ info.first_p_name }}</td>
                    <td>{{ info.manufacturer }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="print-voucher-area">
            <button type="submit" class="print-btn">ğŸ–¨ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸä¼ç¥¨ã®å¸³ç¥¨(PDF)ã‚’å‡ºåŠ›ã™ã‚‹</button>
        </div>
    </form>

    <br>
    <div style="text-align: center;">
        <a href="{{ url_for('dc_in.home') }}">ãƒˆãƒƒãƒ—(ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢)ã¸æˆ»ã‚‹</a>
    </div>
</body>
</html>